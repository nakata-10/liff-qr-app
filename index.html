<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>QR スキャン受付</title>
  <script src="config.js"></script>
  <style>
    body * { display: none; }
    #status, #result {
      display: block;
      text-align: center;
      margin: 2em;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <p id="status">QR 情報を受け付けています…</p>
  <pre id="result"></pre>

  <script>
  (async () => {
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("result");

    // URL パラメータ取得
    const p = new URLSearchParams(location.search);
    const code    = p.get("code");
    const idToken = p.get("idToken");
    const userId  = p.get("userId");

    if (!code || !idToken || !userId) {
      statusEl.textContent = "パラメータが不足しています";
      return;
    }

    statusEl.textContent = "ポイント付与中…";

    try {
      const resp = await fetch(
        // config.js の AZURE_FUNCTION_URL をそのまま使う
        APP_CONFIG.AZURE_FUNCTION_URL,
        {
          method: "POST",
          headers: {
            "Content-Type":  "application/json",
            "Authorization": "Bearer " + idToken
          },
          body: JSON.stringify({
            userId,
            points:    10,
            scanInfo:  { qrText: code, timestamp: new Date().toISOString() }
          })
        }
      );

      if (!resp.ok) {
        throw new Error("HTTP " + resp.status);
      }

      const json = await resp.json();
      statusEl.textContent = "ポイントを正常に付与しました";
      resultEl.textContent = JSON.stringify(json, null, 2);

    } catch (err) {
      statusEl.textContent = "エラーが発生しました: " + err.message;
    }
  })();
  </script>
</body>
</html>
